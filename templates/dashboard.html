{% extends 'base.html' %}
{% block title %}Dashboard{% endblock %}
{% block content %}
<div class="d-flex align-items-center justify-content-between mb-4">
    <div class="d-flex align-items-center">
        <img src="{{ url_for('static', filename='img/logo_gams.png') }}" alt="Logo GAMS"
            style="height: 50px; margin-right: 15px;">
        <h2 class="mb-0">üìä Dashboard de KPIs</h2>
    </div>
</div>
<hr class="mb-4" style="border-top: 1px solid #ccc;">

<div class="text-end mb-4">
    <button onclick="exportarDashboard()" class="btn btn-outline-primary">
        üìÑ Exportar Dashboard completo
    </button>
</div>

{% if alertas %}
<div class="row mb-4">
    {% for alerta in alertas %}
    {% set clase = 'danger' if alerta.tipo == 'caida' else 'warning' %}
    <div class="col-md-12">
        <div class="alert alert-{{ clase }} shadow-sm" role="alert">
            {{ alerta.mensaje }}
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}

<form method="GET" action="{{ url_for('dashboard') }}" class="row g-2 align-items-end mb-4">
    <div class="col-md-3">
        <label for="objetivo_mensual" class="form-label">üéØ Objetivo mensual (‚Ç¨)</label>
        <input type="number" step="0.01" min="0" class="form-control" name="objetivo_mensual" id="objetivo_mensual"
            value="{{ objetivo_mensual }}">
    </div>
    <div class="col-md-3">
        <label for="objetivo_anual" class="form-label">üéØ Objetivo anual (‚Ç¨)</label>
        <input type="number" step="0.01" min="0" class="form-control" name="objetivo_anual" id="objetivo_anual"
            value="{{ objetivo_anual }}">
    </div>
    <div class="col-md-3">
        <input type="hidden" name="filename" value="{{ filename }}">
        <button type="submit" class="btn btn-primary">Actualizar objetivos</button>
    </div>
</form>

<!-- KPIs principales -->
<!-- Total ventas -->
<div class="card p-3 shadow-sm">
    <h5>Total Ventas</h5>
    <h3>{{ total_ventas | default(0) | float | round(2) }} ‚Ç¨</h3>
</div>

<!-- Comensales -->
<div class="card p-3 shadow-sm">
    <h5>Comensales</h5>
    <h3>{{ comensales | default(0) }}</h3>
</div>

<!-- Ticket medio -->
<div class="card p-3 shadow-sm">
    <h5>Ticket Medio</h5>
    <h3>{{ ticket_medio | default(0) | float | round(2) }} ‚Ç¨</h3>
</div>
<h4 class="mt-5">üìà Ventas por Mes</h4>
<canvas id="graficoVentas" height="100"></canvas>

<h4 class="mt-5">üî• Mapa de calor de ventas por d√≠a y hora</h4>
<div class="table-responsive">
    <table class="table table-sm align-middle text-center" style="font-size: 0.85rem;">
        <thead>
            <tr>
                <th style="position: sticky; left: 0; background: var(--bs-body-bg);">D√≠a \ Hora</th>
                {% for h in heatmap_hours %}
                <th>{{ "%02d"|format(h) }}</th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for day in heatmap_days %}
            {% set i = loop.index0 %}
            <tr>
                <th style="position: sticky; left: 0; background: var(--bs-body-bg); text-align: left;">{{ day }}</th>
                {% for h in heatmap_hours %}
                {% set val = heatmap_matrix[i][loop.index0] %}
                {% if heatmap_max and heatmap_max > 0 %}
                {% set ratio = (val / heatmap_max) | round(2) %}
                {% set red = (255 * ratio) | round(0) %}
                {% set green = (255 * (1 - ratio)) | round(0) %}
                {% set bg_color = "rgb(" ~ red ~ "," ~ green ~ ",0)" %}
                {% else %}
                {% set ratio = 0 %}
                {% set bg_color = "rgb(255,255,255)" %}
                {% endif %}
                <td title="‚Ç¨ {{ ('{:,.2f}'.format(val)).replace(',', 'X').replace('.', ',').replace('X', '.') }}"
                    style="background-color: {{ bg_color }}; color: {{ 'white' if ratio > 0.5 else 'black' }};">
                    {{ '‚Äî' if val == 0 else ('‚Ç¨ ' + ('{:,.0f}'.format(val)).replace(',', '.')) }}
                </td>
                {% endfor %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
<p class="text-muted" style="font-size: 0.85rem;">*Verde = ventas bajas ¬∑ Rojo = ventas altas.</p>

<h4 class="mt-5">üìà Comparativa mensual (ventas y ticket)</h4>

<table class="table table-sm table-striped">
    <thead>
        <tr>
            <th>Mes</th>
            <th>Ventas</th>
            <th>Œî Ventas</th>
            <th>Ticket Medio</th>
            <th>Œî Ticket</th>
        </tr>
    </thead>
    <tbody>
        {% for fila in tendencias %}
        <tr>
            <td>{{ fila.mes }}</td>
            <td>{{ fila.ventas | round(2) }} ‚Ç¨</td>
            <td>
                {% if fila.variacion_ventas >= 0 %}
                <span class="badge bg-success">‚¨ÜÔ∏è +{{ fila.variacion_ventas }}%</span>
                {% else %}
                <span class="badge bg-danger">‚¨áÔ∏è {{ fila.variacion_ventas }}%</span>
                {% endif %}
            </td>
            <td>{{ fila.ticket }} ‚Ç¨</td>
            <td>
                {% if fila.variacion_ticket >= 0 %}
                <span class="badge bg-success">‚¨ÜÔ∏è +{{ fila.variacion_ticket }}%</span>
                {% else %}
                <span class="badge bg-danger">‚¨áÔ∏è {{ fila.variacion_ticket }}%</span>
                {% endif %}
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<h4 class="mt-5">üçΩÔ∏è Resumen por Tipo de Servicio</h4>

<table class="table table-sm table-bordered">
    <thead class="table-light">
        <tr>
            <th>Servicio</th>
            <th>Ventas Totales (‚Ç¨)</th>
            <th>Comensales</th>
            <th>Ticket Medio (‚Ç¨)</th>
        </tr>
    </thead>
    <tbody>
        {% for fila in resumen_servicio %}
        <tr>
            <td>{{ fila.tipo }}</td>
            <td>{{ fila.ventas }}</td>
            <td>{{ fila.comensales }}</td>
            <td>{{ fila.ticket_medio }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>



<!-- üìÜ Comparativa A√±o vs. A√±o -->
<h4 class="mt-5">üìÜ Comparativa A√±o vs. A√±o</h4>
<div class="table-responsive">
    <table class="table table-bordered table-sm text-center align-middle">
        <thead class="table-light">
            <tr>
                <th>A√±o</th>
                <th>Ventas Totales</th>
                <th>Variaci√≥n Ventas</th>
                <th>Ticket Medio</th>
                <th>Variaci√≥n Ticket</th>
            </tr>
        </thead>
        <tbody>
            {% for row in resumen_yoy %}
            <tr>
                <td><strong>{{ row.anio }}</strong></td>
                <td>‚Ç¨ {{ "{:,.2f}".format(row.ventas).replace(",", "X").replace(".", ",").replace("X", ".") }}</td>
                <td>
                    {% if row.var_ventas is none %}
                    ‚Äî
                    {% elif row.var_ventas >= 0 %}
                    <span class="badge bg-success">‚¨ÜÔ∏è {{ "{:.1f}".format(row.var_ventas) }}%</span>
                    {% else %}
                    <span class="badge bg-danger">‚¨áÔ∏è {{ "{:.1f}".format(row.var_ventas) }}%</span>
                    {% endif %}
                </td>
                <td>
                    {% if row.ticket_medio is none %}
                    ‚Äî
                    {% else %}
                    ‚Ç¨ {{ "{:,.2f}".format(row.ticket_medio).replace(",", "X").replace(".", ",").replace("X", ".") }}
                    {% endif %}
                </td>
                <td>
                    {% if row.var_ticket is none %}
                    ‚Äî
                    {% elif row.var_ticket >= 0 %}
                    <span class="badge bg-success">‚¨ÜÔ∏è {{ "{:.1f}".format(row.var_ticket) }}%</span>
                    {% else %}
                    <span class="badge bg-danger">‚¨áÔ∏è {{ "{:.1f}".format(row.var_ticket) }}%</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- üí∞ Rentabilidad por tipo de servicio -->
<h4 class="mt-5">üí∞ Rentabilidad por tipo de servicio</h4>
<div class="table-responsive">
    <table class="table table-bordered table-sm text-center align-middle">
        <thead class="table-light">
            <tr>
                <th>Servicio</th>
                <th>Ventas (‚Ç¨)</th>
                <th>Coste (‚Ç¨)</th>
                <th>Rentabilidad (‚Ç¨)</th>
                <th>Margen (%)</th>
            </tr>
        </thead>
        <tbody>
            {% for r in rentabilidad_servicio %}
            <tr>
                <td>{{ r.servicio }}</td>
                <td>‚Ç¨ {{ "{:,.2f}".format(r.ventas).replace(",", "X").replace(".", ",").replace("X", ".") }}</td>
                <td>‚Ç¨ {{ "{:,.2f}".format(r.coste).replace(",", "X").replace(".", ",").replace("X", ".") }}</td>
                <td>‚Ç¨ {{ "{:,.2f}".format(r.rentabilidad).replace(",", "X").replace(".", ",").replace("X", ".") }}</td>
                <td>
                    {% if r.margen >= 0 %}
                    <span class="badge bg-success">{{ "{:.1f}".format(r.margen) }}%</span>
                    {% else %}
                    <span class="badge bg-danger">{{ "{:.1f}".format(r.margen) }}%</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>


<!-- Carga Chart.js desde CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    const ctx = document.getElementById('graficoVentas').getContext('2d');
    const graficoVentas = new Chart(ctx, {
        type: 'bar', // Cambia a 'line' si prefieres una l√≠nea
        data: {
            labels: {{ labels | tojson }},
    datasets: [{
        label: 'Ventas (‚Ç¨)',
        data: {{ valores | tojson }},
        backgroundColor: 'rgba(54, 162, 235, 0.5)',
        borderColor: 'rgba(54, 162, 235, 1)',
        borderWidth: 2
      }]
    },
    options: {
        responsive: true,
            scales: {
            y: {
                beginAtZero: true,
                    ticks: {
                    callback: function(value) {
                        return value + " ‚Ç¨";
                    }
                }
            }
        }
    }
  });
</script>

<h4 class="mt-5">üçΩÔ∏è Ventas por Tipo de Servicio</h4>
<div style="max-width: 400px; margin: auto;">
    <canvas id="graficoServicio"></canvas>
</div>


<script>
    const ctxServicio = document.getElementById('graficoServicio').getContext('2d');
    const graficoServicio = new Chart(ctxServicio, {
        type: 'doughnut',
        data: {
            labels: {{ servicios_labels | tojson }},
    datasets: [{
        label: 'Ventas por Tipo',
        data: {{ servicios_valores | tojson }},
        backgroundColor: [
        'rgba(255, 99, 132, 0.5)',
        'rgba(255, 205, 86, 0.5)',
        'rgba(75, 192, 192, 0.5)'
    ],
        borderColor: [
        'rgba(255, 99, 132, 1)',
        'rgba(255, 205, 86, 1)',
        'rgba(75, 192, 192, 1)'
    ],
        borderWidth: 1
      }]
    },
    options: {
        responsive: true
    }
  });
</script>

<h4 class="mt-5">üí≥ Ticket Medio por Mes</h4>
<canvas id="graficoTicket" height="100"></canvas>

<script>
    const ctxTicket = document.getElementById('graficoTicket').getContext('2d');
    const graficoTicket = new Chart(ctxTicket, {
        type: 'line',
        data: {
            labels: {{ ticket_labels | tojson }},
    datasets: [{
        label: 'Ticket Medio (‚Ç¨)',
        data: {{ ticket_valores | tojson }},
        backgroundColor: 'rgba(153, 102, 255, 0.3)',
        borderColor: 'rgba(153, 102, 255, 1)',
        borderWidth: 2,
        tension: 0.3,
        fill: true
      }]
    },
    options: {
        responsive: true,
            scales: {
            y: {
                beginAtZero: true,
                    ticks: {
                    callback: function(value) {
                        return value + " ‚Ç¨";
                    }
                }
            }
        }
    }
  });
</script>


<!-- Objetivos (si existen) -->
{% if comparativa %}
<h4 class="mt-4">üéØ Comparativa con Objetivos</h4>
{% if comparativa.mensual %}
<ul class="list-group my-3">
    {% for mes, valor, estado in comparativa.mensual %}
    <li class="list-group-item d-flex justify-content-between">
        <strong>{{ mes }}</strong>
        <span>{{ valor | round(2) }} ‚Ç¨ ¬∑ {{ estado }}</span>
    </li>
    {% endfor %}
</ul>
{% endif %}
{% if comparativa.anual %}
<div class="alert alert-info">
    <strong>A√±o {{ comparativa.anual[0] }}:</strong>
    {{ comparativa.anual[1] | round(2) }} ‚Ç¨ ¬∑ {{ comparativa.anual[2] }}
</div>
{% endif %}
{% endif %}

<!-- Top d√≠as de facturaci√≥n -->
<h4 class="mt-4">üî• D√≠as con Mayor Facturaci√≥n</h4>
<ul class="list-group mb-4">
    {% for fecha, importe in top_dias.items() %}
    <li class="list-group-item d-flex justify-content-between">
        <span>{{ fecha }}</span>
        <strong>{{ importe | round(2) }} ‚Ç¨</strong>
    </li>
    {% endfor %}
</ul>

<a href="/" class="btn btn-secondary">üîÑ Subir otro archivo</a>

<!-- Estilos para impresi√≥n (solo se aplican al imprimir o guardar PDF) -->
<style>
    @media print {

        .btn,
        nav,
        footer {
            display: none !important;
        }

        body {
            zoom: 90%;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
            margin: 0;
            padding: 0;
        }

        .container {
            margin: 0;
            padding: 0;
        }

        .card,
        .alert {
            page-break-inside: avoid;
        }
    }
</style>

<!-- Script para exportar el dashboard -->
<script>
    function exportarDashboard() {
        window.scrollTo(0, 0);
        setTimeout(() => {
            window.print();
        }, 300);
    }
</script>

{% endblock %}